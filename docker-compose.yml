version: '3.4'
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    volumes:
      - ./pyweb:/pyweb/pyweb:ro
      - ./config:/pyweb/config:ro
      - /media/j/notebooks:/notebooks
    ports:
      - "4445:8000"
    extra_hosts:
      - quantsrv:192.168.100.15
    env_file:
      - .config
    command:
      ./start.py

  jupyter:
    build:
      context: .
      dockerfile: Dockerfile-Jupyter

    extra_hosts:
        - quantsrv:192.168.100.15

    volumes:
      - ./work:/home/${NB_USER}/work
      - ./pyweb:/home/${NB_USER}/work/pyweb
    working_dir: /home/${NB_USER}/work

    env_file:
      - .config
    ports:
      - ${PORT}:8888

  test:
     build:
       context: .
       dockerfile: Dockerfile
       target: test

     volumes:
        - ./pyweb:/pyweb/pyweb:ro
        - ./test:/pyweb/test:ro
        - ./artifacts:/pyweb/artifacts
        - ./helpers:/opt/.pycharm_helpers/pycharm:ro
     links:
       - test-postgresql


  test-postgresql:
    image: postgres:9.6
